회사에서 담당하고 있는 프로젝트 중에 결제와 정산과 관련된 부분이 있는데, 결제 후 월 단위 정산을 위한 테이블에 결제 이후 데이터를 업데이트 하도록 되어 있는 부분이 존재한다.

해당 부분이 비동기로 설계되지 않아 api를 호출하고 그에 대한 리스폰스를 동기적으로 처리하도록 구성이 되어있었는데, 3월 데이터에서 한 계정이 해당 프로젝트 배포 중 결제 시도를 하여, 결제 리스폰스를 처리하지 못해 데이터가 업데이트 되지 않은 문제가 발생했었다.

다행이 일별 그리고 월별로 결제 팀의 데이터와 우리 쪽의 데이터를 비교하여 체크하는 배치잡을 구성해 놨기 때문에 바로 알 수는 있었지만, 데이터의 구성이 잘못 되었다는게 문제가 되어 이를 처리하는 게 필요했다.

일단 해당 데이터는 결제 팀의 데이터를 기반으로 업데이트 후 3월 정산 리포트를 다시 재싱크하는 것으로 해결이 되었다. 다행히 결제와 관련된 데이터를 UI에 구성할 때에는 결제 팀의 데이터를 기반으로 사용을 했었기 때문에 데이터가 잘못 보여진다거나 하지는 않았다.

결제 시스템은 돈과 연관이 되어있어 데이터의 누락이 용납이 되지 않기 때문에 '결제' - '결제 결과 처리' 를 동기적으로 처리하는 것이 아니라 이벤트 기반으로 제대로 처리 되지 않는다면 재처리 하도록 구성이 되는게 좋을 것 같다. 물론 우리 쪽 프로젝트가 그레이스풀 셧다운이 안되고 프로그램이 내려갈 때 sleep() 메서드와 매직 넘버로 처리되고 있는 것도 문제...